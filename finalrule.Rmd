---
title: "FinalRuleEDA"
author: "Chenery Lowe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=TRUE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

# set working directory
setwd("C:/Users/clowe7/OneDrive - Stanford/Final Rule Analysis") #***You'll want to change the working directory to reflect the location where your files are stored

# install packages
library(dplyr)
library(readxl)
library(tidyverse)
library(ggplot2)
library(tidyverse)
library(arsenal)
library(psych)
library(corrplot)
library(car)
library(stargazer)

# load data file ***Make sure that the file is in the working directory that you set above; otherwise, you will need to specify the full pathway
data_labels<-read.csv("102 Survey_AssessingGeneticCoun-ForDataAnalysis_DATA_LABELS_2024-02-06_1407 (1).csv")

data<-read.csv("AssessingGeneticCoun-ForDataAnalysis_DATA_2024-02-25_1458.csv")

#Analysis 1a: The existence of direct contact, institutional policies, 
#dept/division/workgroup policies, blocking policies, and changes to pt portal 
#policies are associated with less perceived disruption to workflow, less 
#perceived pt harms, and more perceived pt benefits.

# Recode policies as 0 if it does not exist or not sure, NA if NA, and 1 if anything else
data$policies_dept_1a <- ifelse(data$policies_dept %in% c(4, 5), 0,
                                 ifelse(data$policies_dept == 6, NA,
                                        ifelse(data$policies_dept %in% c(1, 2, 3), 1, data$policies_dept)
                                       ))

# Recoding the 'data$policies_institutional' variable
data$policies_institutional_1a <- ifelse(data$policies_instituitional %in% c(4, 5), 0,
                                  ifelse(data$policies_instituitional == 6, NA,
                                         ifelse(data$policies_instituitional %in% c(1, 2, 3), 1, data$policies_instituitional)
                                        ))

# Recoding the 'data$policies_portal' variable
data$policies_portal_1a <- ifelse(data$policies_portal %in% c(4, 5), 0,
                                ifelse(data$policies_portal == 6, NA,
                                       ifelse(data$policies_portal %in% c(1, 2, 3), 1, data$policies_portal)
                                      ))


#Analysis1b: The involvement of GCs in these policies is associated with less 
#perceived disruption to workflow, less perceived pt harms, and more perceived 
#pt benefits.
# recode variables for analysis 1b (GC involved in policy vs. not involved vs. no known policy)
# Recoding policies_institutional
data$policies_institutional_1b <- ifelse(data$policies_instituitional == 1, 2,
                                  ifelse(data$policies_instituitional == 2, 1,
                                         ifelse(data$policies_instituitional == 3, 1,
                                                ifelse(data$policies_instituitional %in% c(4, 5), 0,
                                                       ifelse(data$policies_instituitional == 6, NA, data$policies_institutional)
                                                      ))))

# Recoding policies_dept
data$policies_dept_1b <- ifelse(data$policies_dept == 1, 2,
                          ifelse(data$policies_dept == 2, 1,
                                 ifelse(data$policies_dept == 3, 1,
                                       ifelse(data$policies_dept %in% c(4, 5), 0,
                                              ifelse(data$policies_dept == 6, NA, data$policies_dept)
                                             ))))

# Recoding policies_portal
data$policies_portal_1b <- ifelse(data$policies_portal == 1, 2,
                            ifelse(data$policies_portal == 2, 1,
                                   ifelse(data$policies_portal == 3, 1,
                                         ifelse(data$policies_portal %in% c(4, 5), 0,
                                                ifelse(data$policies_portal == 6, NA, data$policies_portal)
                                               ))))


#perceived harms
data$pt_reaction <- ifelse(data$pt_reaction == 6, NA, data$pt_reaction)
data$pt_understand <- ifelse(data$pt_understand == 6, NA, data$pt_understand)
data$pt_contact <- ifelse(data$pt_contact == 6, NA, data$pt_contact)


#perceived benefits
data$pt_empower <- ifelse(data$pt_empower == 6, NA, data$pt_empower)
data$pt_processing <- ifelse(data$pt_processing == 6, NA, data$pt_processing)
data$pt_assurance <- ifelse(data$pt_assurance == 6, NA, data$pt_assurance)
data$pt_action <- ifelse(data$pt_action == 6, NA, data$pt_action)
data$pt_share <- ifelse(data$pt_share == 6, NA, data$pt_share)

#workplace effects
data$checking <- ifelse(data$checking == 6, NA, data$checking)
data$timing <- ifelse(data$timing == 6, NA, data$timing)
data$communications <- ifelse(data$communications == 6, NA, data$communications)
data$change <- ifelse(data$change == 6, NA, data$change)
data$coordination_dept <- ifelse(data$coordination_dept == 6, NA, data$coordination_dept)
data$coordination_other <- ifelse(data$coordination_other == 6, NA, data$coordination_other)
data$sending_results <- ifelse(data$sending_results == 6, NA, data$sending_results)


# DEMOGRAPHIC VARIABLES

# years of GC experience as ordered factor variable
data$demo_years <- factor(data$demo_years, levels = 1:8, ordered = TRUE)

# age as ordered factor variable
data$demo_age <- factor(data$demo_age, levels = 1:11, ordered = TRUE)

# position as ordered factor
data$position <- factor(data$position, 
                                 levels = 1:3, 
                                 labels = c("Direct patient care",
                                            "Non-direct patient care",
                                            "Mixed position"))

# ordering provider
data$ordering_provider <- factor(data$ordering_provider, 
                                 levels = 1:4, 
                                 labels = c("Yes. I place and sign orders as the provider of record",
                                            "No. I place the order but am not listed as the ordering provider",
                                            "No. I cannot place or sign orders",
                                            "No. I do not order in my role"))

# region
data$demo_list <- factor(data$demo_list, 
                                 levels = 1:6, 
                                 labels = c("Region 1 (CT, MA, ME, NH, RI, VT, CNMaritime Provinces)",
                                            "Region 2 (DC, DE, MD, NJ, NY, PA, VA, WV,PR, VI, Quebec)",
                                            "Region 3 (AL, FL, GA, KY, LA, MS, NC, SC,TN)",
                                            "Region 4 (AR, IA, IL, IN, KS, MI, MN, MO,ND, NE, OH, OK, SD, WI, Ontario)",
                                            "Region 5 (AZ, CO, MT, NM, TX, UT, WY, Alberta, Manitoba, Sask.)",
                                            "Region 6 (AK, CA, HI, ID, NV, OR, WA, British Columbia)"))


# convert race/ethnicity variables to factor
for (i in 1:8) {
  var_name <- paste0("demo_raceethnicity___", i)
  data[[var_name]] <- factor(data[[var_name]], 
                             levels = 0:1, 
                             labels = c("NA", "1"))
}

#clean workplace setting variable
workplace_labels <- list(
  "Government organization or agency",
  "Hospital/Medical Facility- Academic Medical Center",
  "Hospital/Medical Facility- Public or Community Based Hospital (including FQHC)",
  "Hospital/Medical Facility- Private",
  "Insurance Company/Benefit Management Company",
  "Laboratory Commercial",
  "Not-For-Profit Organization (non-hospital)",
  "Private Practice",
  "Private Company-Biotechnology/ Research development, Digital Health/Software, Pharmaceutical",
  "Other")

# Create a matrix for the workplacesettings
workplace_matrix <- data.frame(data[ , grepl("^workplacesetting___", names(data))])


# Create the workplacesetting variable following your requirements
data$workplacesetting <- apply(workplace_matrix, 1, function(x) {
  indices <- which(x == 1)
  if(length(indices) > 1) {
    return("Multiple")
  } else if(length(indices) == 1) {
    return(workplace_labels[[indices]])
  } else {
    return("None")
  }
})

# Create the workplace_multiple variable
data$workplace_multiple <- apply(workplace_matrix, 1, function(x) {
  indices <- which(x == 1)
  if(length(indices) > 1) {
    return(paste(workplace_labels[indices], collapse = ","))
  } else {
    return(NA)
  }
})


# set up labels for the participant characteristics table ***This list isn't complete - add the rest of the variable names here
labs<- c(demo_age = "Age",
         demo_list = "Region",
         demo_years = "Years of experience as a practicing GC"
)

```

## Summary table
```{r, results='asis'}
# select the relevant variables
desc<-data%>%
  select(position, demo_years, workplacesetting, ordering_provider, demo_list, demo_raceethnicity___1:demo_raceethnicity___8, demo_age) # ***add more demographic variables if needed

# variable labels
labels(desc)<-labs

#create formula
myvars<-names(desc)
tmp<-formulize(X=myvars[1:(ncol(desc))])

# *** if you wanted to stratify by a variable, you could do this: tmp<-formulize("***variable name", myvars[1:(ncol(desc))])

summary(tableby(tmp, data = desc,
              digits = 2L))


```

## Factor analysis for outcome variables

### Perceived benefits
```{r}
# subset perceived benefits variables
ben <- data %>%
  select(pt_empower:pt_share) %>%
  mutate_all(as.numeric)

# Now omit NA values
ben <- na.omit(ben)

# correlation matrix
datamatrix<-cor(ben)
corrplot::corrplot(datamatrix, method = "number")

# analyze factorability of the data
X<-ben

#Kaiser-Meyer Olkin
KMO(r=cor(X))

#Bartlett's test of sphericity
cortest.bartlett(X)
det(cor(X))

# scree plot
library(ggplot2)
fafitfree <- fa(ben,nfactors = ncol(X), rotate = "none")
n_factors <- length(fafitfree$e.values)
scree     <- data.frame(
  Factor_n =  as.factor(1:n_factors), 
  Eigenvalue = fafitfree$e.values)
ggplot(scree, aes(x = Factor_n, y = Eigenvalue, group = 1)) + 
  geom_point() + geom_line() +
  xlab("Number of factors") +
  ylab("Initial eigenvalue") +
  labs( title = "Scree Plot", 
        subtitle = "(Based on the unreduced correlation matrix)")

parallel<-fa.parallel(X)

# 1 factor
factanal_1 <- factanal(X, factors=1, scores = c("regression"), rotation = "varimax")
print(factanal_1)

# 2 factors
factanal_2 <- factanal(X, factors=2, scores = c("regression"), rotation = "varimax")
print(factanal_2)

# check internal consistency of benefits variables (Cronbach's alpha)

# correlation matrix
datamatrix<-cor(ben)
corrplot::corrplot(datamatrix, method = "number")

# Cronbach's alpha, allowing negatively correlated items to be reversed
psych::alpha(X, check.keys = TRUE)

# create benefits score
data$benefits <- rowSums(data[,c("pt_empower", "pt_processing", "pt_assurance", "pt_action", "pt_share")], na.rm = TRUE)


```
### Perceived harms
```{r}
# subset perceived harms variables
harm <- data %>%
  select(pt_reaction:pt_contact) %>%
  mutate_all(as.numeric)

# Omit NA values
harm <- na.omit(harm)

# correlation matrix
datamatrix<-cor(harm)
corrplot::corrplot(datamatrix, method = "number")

# analyze factorability of the data
X<-harm

#Kaiser-Meyer Olkin
KMO(r=cor(X))

#Bartlett's test of sphericity
cortest.bartlett(X)
det(cor(X))

# scree plot
library(ggplot2)
fafitfree <- fa(harm,nfactors = ncol(X), rotate = "none")
n_factors <- length(fafitfree$e.values)
scree     <- data.frame(
  Factor_n =  as.factor(1:n_factors), 
  Eigenvalue = fafitfree$e.values)
ggplot(scree, aes(x = Factor_n, y = Eigenvalue, group = 1)) + 
  geom_point() + geom_line() +
  xlab("Number of factors") +
  ylab("Initial eigenvalue") +
  labs( title = "Scree Plot", 
        subtitle = "(Based on the unreduced correlation matrix)")

parallel<-fa.parallel(X)

# 1 factor
factanal_1 <- factanal(X, factors=1, scores = c("regression"), rotation = "varimax")
print(factanal_1)

# check internal consistency of variables (Cronbach's alpha)

# correlation matrix
datamatrix<-cor(harm)
corrplot::corrplot(datamatrix, method = "number")

# Cronbach's alpha, allowing negatively correlated items to be reversed
psych::alpha(X, check.keys = TRUE)

# create harms score
data$harms <- rowSums(data[,c("pt_reaction", "pt_understand", "pt_contact")], na.rm = TRUE)

```

### Perceived impact on workflow
```{r}
# subset perceived workflow impact variables
work <- data %>%
  select(checking:coordination_other) %>%
  mutate_all(as.numeric)

# Omit NA values
work <- na.omit(work)

# correlation matrix
datamatrix<-cor(work)
corrplot::corrplot(datamatrix, method = "number")

# analyze factorability of the data
X<-work

#Kaiser-Meyer Olkin
KMO(r=cor(X))

#Bartlett's test of sphericity
cortest.bartlett(X)
det(cor(X))

# scree plot
library(ggplot2)
fafitfree <- fa(work,nfactors = ncol(X), rotate = "none")
n_factors <- length(fafitfree$e.values)
scree     <- data.frame(
  Factor_n =  as.factor(1:n_factors), 
  Eigenvalue = fafitfree$e.values)
ggplot(scree, aes(x = Factor_n, y = Eigenvalue, group = 1)) + 
  geom_point() + geom_line() +
  xlab("Number of factors") +
  ylab("Initial eigenvalue") +
  labs( title = "Scree Plot", 
        subtitle = "(Based on the unreduced correlation matrix)")

parallel<-fa.parallel(X)

# 1 factor
factanal_1 <- factanal(X, factors=1, scores = c("regression"), rotation = "varimax")
print(factanal_1)

# 2 factors
factanal_2 <- factanal(X, factors=2, scores = c("regression"), rotation = "varimax")
print(factanal_2)

# check internal consistency of variables (Cronbach's alpha)

# correlation matrix
datamatrix<-cor(work)
corrplot::corrplot(datamatrix, method = "number")

# Cronbach's alpha, allowing negatively correlated items to be reversed
psych::alpha(X, check.keys = TRUE)

# create workflow impact score - dropping last item
data$work <- rowSums(data[,c("checking", "timing", "communications", "change", "coordination_dept", "coordination_other")], na.rm = TRUE)

```

## Bivariate analyses for presence/absence of policy (how is each individual predictor related to each individual outcome and outcome categories) – logistic and linear
```{r, results='asis'}
# to do a summary table for departmental/workgroup policies

# select the relevant variables
desc<-data%>%
  select(policies_dept_1a, pt_empower) # ***add more outcome variables

#convert numeric to factor variables, if needed ***may not be needed if converted to factor in an earlier step
desc$pt_empower<-as.factor(desc$pt_empower)

# variable labels
labels(desc)<-labs

#create formula
myvars<-names(desc)
tmp<-formulize("policies_dept_1a", myvars[2:(ncol(desc))])

summary(tableby(tmp, data = desc,
              digits = 2L))


```


## Bivariate analyses for GC involvement in policy – logistic and linear (similar to previous chunk)



## Multiple linear regression models relating predictors (resources, policies, changes to practice) to outcomes (impact on workflow, pt harms, pt benefits), adjusting for GC and workplace characteristics

### Example b1a1: Does existence of department policies influence perceived benefits?
```{r}
#subset the variables that you are considering using in the model ***change these if needed
tmp<- subset(data, select = c("benefits", "policies_dept_1a", "ordering_provider", "position", "workplacesetting", "demo_years"))
             
#subset cases with non-missing data
tmp<-tmp[complete.cases(tmp),]

#define intercept-only model
intercept<-lm(benefits ~ 1, data = tmp)

#define model with all predictors
all<-lm(benefits~., data = tmp)

#perform forward and back stepwise regression
both<-step(intercept, direction= "both", scope = formula(all), trace = 0)

#view covariates selected by stepwise selection
both$coefficients

#fit model using these variables ***change these as needed - only position was selected in this case
b1a1<-lm(benefits~ policies_dept_1a + position, data = tmp)

#check for multicollinearity - calculate variance-inflation factor
car::vif(b1a1)

#view summary stats for selected model
summary(b1a1)

#assess normality
#regression diagnostics
library(ggfortify)
autoplot(b1a1)
shapiro.test(b1a1$residuals) #assess normality of residuals
```

### b1a2 Does existence of institutional policies influence perceived benefits?

```{r}
#*** WRITE CODE HERE - use the previous code as a template using "policies_institutional_1a" as the main predictor, "benefits" as the outcome, and the same covariates. Change the formula if different covariates are selected via stepwise selection

```


### b1a3 Does existence of portal policies influence perceived benefits?

### h1a1 Does existence of department policies influence perceived harms?

### h1a2 Does existence of institutional policies influence perceived harms?

### h1a3 Does existence of portal policies influence perceived harms?


# create regression table
```{r}
stargazer(b1a1, #***add more models here - e.g., b1a2, b1a3
          type = "html",
          out = "benefits_1a.doc", #output will be as a separate word document
          single.row = TRUE,
          no.space = TRUE,
          title = "Effects of deparmental, institutional, and portal policies on perceived benefits")

#*** you can customize variable labels, order of variables, which stats to exclude, etc. - see https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf

```

