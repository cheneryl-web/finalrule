---
title: "FinalRuleEDA"
author: "Chenery Lowe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=TRUE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

# set working directory
setwd("C:/Users/clowe7/OneDrive - Stanford/Final Rule Analysis") #***You'll want to change the working directory to reflect the location where your files are stored

# install packages
library(dplyr)
library(readxl)
library(tidyverse)
library(ggplot2)
library(tidyverse)
library(arsenal)

# load data file ***Make sure that the file is in the working directory that you set above; otherwise, you will need to specify the full pathway
data<-read.csv("102 Survey_AssessingGeneticCoun-ForDataAnalysis_DATA_LABELS_2024-02-06_1407 (1).csv")

data_raw<-read.csv("AssessingGeneticCoun-ForDataAnalysis_DATA_2024-02-25_1458.csv")

# ***May need to clean, convert, or recode variables - here's one example

# convert years experience as ordered factor variable
# Create a vector of levels in correct order
levels <- c("1- 4 years", "5- 9 years", "10- 14 years", "15- 19 years", "20- 24 years", "25- 29 years")

# Convert to an ordered factor
data$How.many.years.experience.do.you.have.as.a.practicing.genetic.counselor..round.to.the.nearest.year.. <- factor(data$How.many.years.experience.do.you.have.as.a.practicing.genetic.counselor..round.to.the.nearest.year.., levels = levels, ordered = TRUE)



# set up labels for the participant characteristics table ***This list isn't complete - add the rest of the variable names here
labs<- c(What.is.your.age.in.years. = "Age")

```

# Summary table
```{r, results='asis'}
# select the relevant variables
desc<-data%>%
  select(What.is.your.age.in.years.) # ***add more demographic variables

# variable labels
labels(desc)<-labs

#create formula
myvars<-names(desc)
tmp<-formulize(X=myvars[1:(ncol(desc))])

# *** if you wanted to stratify by a variable, you could do this: tmp<-formulize("***variable name", myvars[1:(ncol(desc))])

summary(tableby(tmp, data = desc,
              digits = 2L))


```
# recode variables for workplace policies variable - analysis 1a (presence vs. absence of the policy)
```{r}
# Recode institutional policies as 0 if it does not exist or not sure, NA if NA, and 1 if anything else
data$policies_institutional_1a <- ifelse(data$institutional.level.policies.for.results.notes.release. %in% 
                                           c("This DOES NOT exist", "I am not sure"), 0,
                                         ifelse(is.na(data$institutional.level.policies.for.results.notes.release.), NA, 
                                                                                                1))

# Recode dept policies variable in raw dataset
data_raw$policies_dept_1a <- ifelse(data_raw$policies_dept %in% c(4, 5), 0,
                                 ifelse(data_raw$policies_dept == 6, NA,
                                        ifelse(data_raw$policies_dept %in% c(1, 2, 3), 1, data_raw$policies_dept)
                                       ))

```


# recode variables for analysis 1b (GC involved in policy vs. not involved vs. no known policy)
```{r}
#***adapt from the previous coding chunk
```


# recode variables for outcomes (harms, benefits, and workflow impact)
```{r}
# Create a vector of variable names
var.names <- c("need.to.check.the.electronic.medical.record.and.or.my.email.more.frequently.") #add more variable names

# Loop over the variables
for (var in var.names) {

  # Create a new variable name with the suffix '_rc'
  new.var <- paste(var, "rc", sep = "_")

  # Apply recode and create a new variable in data
  data[[new.var]] <- recode(data[[var]], 
                            "Strongly agree" = 5, 
                            "Agree" = 4, 
                            "Neither agree nor disagree" = 3, 
                            "Disagree" = 2, 
                            "Strongly disagree" = 1,
                            "Not applicable for my position" = NA_real_)
}

# ***Here's some sample code to reverse-code a variable (e.g., for sending results variable) - may need to modify variable names: 
# data$sending_results_rc <- recode(data$sending_results, `5` = 1, `4` = 2, `3` = 3, `2` = 4, `1` = 5, .default = NA_real_)

```


# total the items for each outcome category
```{r}
# WORKFLOW
# define columns to sum for workflow category
cols_to_sum <-c("need.to.check.the.electronic.medical.record.and.or.my.email.more.frequently._rc") #***add the rest of the workflow variables

# create a new column for the summed columns
data$workflow_total <- rowSums(data[cols_to_sum], na.rm = TRUE)


# *** similar process for benefits and risks variables

```


# explore the distribution for numerical variables (workflow variables, in this example)
```{r}
#histogram
hist(data$workflow_total)

#summary stats
summary(data$workflow_total)

#boxplot
boxplot(data$workflow_total)

#boxplot to compare public hospital/FQHC vs. other
boxplot(data$workflow_total ~ data$In.what.setting.s..do.you.currently.work...select.all.that.apply...choice.Hospital.Medical.Facility..Public.or.Community.Based.Hospital..including.FQHC..)

#Shapiro-Wilk test for normality
shapiro.test(data$workflow_total)

#QQ plot vs. normal
qqnorm(data$workflow_total)
qqline(data$workflow_total)

```

# To-do next:

## Factor analysis for outcome variables

### Perceived benefits

```{r}
library(psych)
library(corrplot)
library(car)

# subset perceived benefits variables
ben<-data_raw%>%subset(select = c(pt_empower:pt_share)) %>% mutate_all(as.numeric) %>% mutate_all(na.omit)

# correlation matrix
datamatrix<-cor(ben)
corrplot::corrplot(datamatrix, method = "number")

# analyze factorability of the data
X<-ben

#Kaiser-Meyer Olkin
KMO(r=cor(X))

#Bartlett's test of sphericity
cortest.bartlett(X)
det(cor(X))

# scree plot
library(ggplot2)
fafitfree <- fa(ben,nfactors = ncol(X), rotate = "none")
n_factors <- length(fafitfree$e.values)
scree     <- data.frame(
  Factor_n =  as.factor(1:n_factors), 
  Eigenvalue = fafitfree$e.values)
ggplot(scree, aes(x = Factor_n, y = Eigenvalue, group = 1)) + 
  geom_point() + geom_line() +
  xlab("Number of factors") +
  ylab("Initial eigenvalue") +
  labs( title = "Scree Plot", 
        subtitle = "(Based on the unreduced correlation matrix)")

parallel<-fa.parallel(X)

# 1 factor
factanal_1 <- factanal(X, factors=1, scores = c("regression"), rotation = "varimax")
print(factanal_1)

# 2 factors
factanal_2 <- factanal(X, factors=2, scores = c("regression"), rotation = "varimax")
print(factanal_2)

# check internal consistency of benefits variables (Cronbach's alpha)

# correlation matrix
datamatrix<-cor(ben)
corrplot::corrplot(datamatrix, method = "number")

# Cronbach's alpha, allowing negatively correlated items to be reversed
psych::alpha(X, check.keys = TRUE)

# create benefits score
data_raw$benefits <- rowSums(data_raw[,c("pt_empower", "pt_processing", "pt_assurance", "pt_action", "pt_share")], na.rm = TRUE)


```
### Do the same for perceived harms and perceived impact on workflow



## Bivariate analyses for presence/absence of policy (how is each individual predictor related to each individual outcome and outcome categories) – logistic and linear
```{r, results='asis'}
# to do this one at a time:
table(data$policies_dept_1a, data$are.empowered.due.to.direct.access.to.their.medical.records., useNA = "always")


# to do a summary table for departmental/workgroup policies

# select the relevant variables
desc<-data%>%
  select(policies_dept_1a, are.empowered.due.to.direct.access.to.their.medical.records.) # ***add more outcome variables

# variable labels
labels(desc)<-labs

#create formula
myvars<-names(desc)
tmp<-formulize("policies_dept_1a", myvars[2:(ncol(desc))])

summary(tableby(tmp, data = desc,
              digits = 2L))


```


## Bivariate analyses for GC involvement in policy – logistic and linear (similar to previous chunk)



## Multiple linear regression models relating predictors (resources, policies, changes to practice) to outcomes (impact on workflow, pt harms, pt benefits), adjusting for GC and workplace characteristics

```{r}
#subset the variables that you are considering using in the model ***change these as needed - maybe add workplace setting, years of training, etc.
tmp<- subset(data_raw, select = c("benefits", "policies_dept_1a", "ordering_provider", "position"))
             
#subset cases with non-missing data
tmp<-tmp[complete.cases(tmp),]

#define intercept-only model
intercept<-lm(benefits ~ 1, data = tmp)

#define model with all predictors
all<-lm(benefits~., data = tmp)

#perform forward and back stepwise regression
both<-step(intercept, direction= "both", scope = formula(all), trace = 0)

#view covariates selected by stepwise selection
both$coefficients

#fit model using these variables ***change these as needed
ben1a<-lm(benefits~ policies_dept_1a + ordering_provider + position, data = tmp)

#check for multicollinearity - calculate variance-inflation factor
car::vif(ben1a)

#view summary stats for selected model
summary(ben1a)

#assess normality
#regression diagnostics
library(ggfortify)
autoplot(ben1a)
shapiro.test(ben1a$residuals) #assess normality of residuals
```


